/*
* --	BitmapSequence.js modified	--
*
* Point by Grant Skinner. Dec 5, 2010
* Visit http://easeljs.com/ for documentation, updates and examples.
*
*
* Copyright (c) 2010 Grant Skinner
* 
* Permission is hereby granted, free of charge, to any person
* obtaining a copy of this software and associated documentation
* files (the "Software"), to deal in the Software without
* restriction, including without limitation the rights to use,
* copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the
* Software is furnished to do so, subject to the following
* conditions:
* 
* The above copyright notice and this permission notice shall be
* included in all copies or substantial portions of the Software.
* 
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
* OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
* NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
* HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
* WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
* FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
* OTHER DEALINGS IN THE SOFTWARE.
*/

(function(window){SpriteSheetUtils=function(){throw"SpriteSheetUtils cannot be instantiated";}
SpriteSheetUtils._workingCanvas=document.createElement("canvas");SpriteSheetUtils._workingContext=SpriteSheetUtils._workingCanvas.getContext("2d");SpriteSheetUtils.flip=function(spriteSheet,flipData){var image=spriteSheet.image;var frameData=spriteSheet.frameData;var frameWidth=spriteSheet.frameWidth;var frameHeight=spriteSheet.frameHeight;var cols=image.width/frameWidth|0;var rows=image.height/frameHeight|0;var ttlFrames=cols*rows;var frData={};var data;for(var n in frameData){data=frameData[n];if(data instanceof Array){data=data.slice(0);}
frData[n]=data;}
var map=[];var frCount=0;var i=0;for(n in flipData){var fd=flipData[n];data=frameData[fd[0]];if(data==null){continue;}
if(data instanceof Array){var start=data[0];var end=data[1];if(end==null){end=start;}}else{start=end=data;}
map[i]=n;map[i+1]=start;map[i+2]=end;frCount+=end-start+1;i+=4;}
var canvas=SpriteSheetUtils._workingCanvas;canvas.width=image.width;canvas.height=Math.ceil(rows+frCount/cols)*frameHeight;var ctx=SpriteSheetUtils._workingContext;ctx.drawImage(image,0,0,cols*frameWidth,rows*frameHeight,0,0,cols*frameWidth,rows*frameHeight);var frame=ttlFrames-1;for(i=0;i<map.length;i+=4){n=map[i];start=map[i+1];end=map[i+2];fd=flipData[n];var flipH=fd[1]?-1:1;var flipV=fd[2]?-1:1;var offH=flipH==-1?frameWidth:0;var offV=flipV==-1?frameHeight:0;for(var j=start;j<=end;j++){frame++;ctx.save();ctx.translate((frame%cols)*frameWidth+offH,(frame/cols|0)*frameHeight+offV);ctx.scale(flipH,flipV);ctx.drawImage(image,(j%cols)*frameWidth,(j/cols|0)*frameHeight,frameWidth,frameHeight,0,0,frameWidth,frameHeight);ctx.restore();}
frData[n]=[frame-(end-start),frame,fd[3]];}
var img=new Image();img.src=canvas.toDataURL("image/png");return new SpriteSheet((img.width>0)?img:canvas,frameWidth,frameHeight,frData);}
SpriteSheetUtils.frameDataToString=function(frameData){var str="";var max=0;var min=0;var count=0;var data,next;for(var n in frameData){count++;data=frameData[n];if(data instanceof Array){var start=data[0];var end=data[1];if(end==null){end=start;}
next=data[2];if(next==null){next=n;}}else{start=end=data;next=n;}
str+="\n\t"+n+", start="+start+", end="+end+", next="+next;if(next==false){str+=" (stop)";}
else if(next==n){str+=" (loop)";}
if(end>max){max=end;}
if(start<min){min=start;}}
str=count+" sequences, min="+min+", max="+max+str;return str;}
SpriteSheetUtils.extractFrame=function(spriteSheet,frame){var image=spriteSheet.image;var frameWidth=spriteSheet.frameWidth;var frameHeight=spriteSheet.frameHeight;var cols=image.width/frameWidth|0;if(isNaN(frame)){var data=spriteSheet.frameData[frame];if(data instanceof Array){frame=data[0];}
else{frame=data;}}
var canvas=SpriteSheetUtils._workingCanvas;canvas.width=frameWidth;canvas.height=frameHeight;SpriteSheetUtils._workingContext.drawImage(image,(frame%cols)*frameWidth,(frame/cols|0)*frameHeight,frameWidth,frameHeight,0,0,frameWidth,frameHeight);var img=new Image();img.src=canvas.toDataURL("image/png");return img;}
window.SpriteSheetUtils=SpriteSheetUtils;}(window));(function(window){Ticker=function(){throw"Ticker cannot be instantiated.";}
Ticker._listeners=[];Ticker._pauseable=[];Ticker._paused=false;Ticker._inited=false;Ticker._startTime=0;Ticker._pausedTime=0;Ticker._ticks=0;Ticker._pausedTickers=0;Ticker._interval=50;Ticker._intervalID=null;Ticker._lastTime=0;Ticker._times=[];Ticker.addListener=function(o,pauseable){if(!Ticker._inited){Ticker._inited=true;Ticker.setInterval(Ticker._interval);}
this.removeListener(o);Ticker._pauseable[Ticker._listeners.length]=(pauseable==null)?true:pauseable;Ticker._listeners.push(o);}
Ticker.removeListener=function(o){if(Ticker._listeners==null){return;}
var index=Ticker._listeners.indexOf(o);if(index!=-1){Ticker._listeners.splice(index,1);Ticker._pauseable.splice(index,1);}}
Ticker.removeAllListeners=function(){Ticker._listeners=[];Ticker._pauseable=[];}
Ticker.setInterval=function(interval){if(Ticker._intervalID!=null){clearInterval(Ticker._intervalID);}
Ticker._lastTime=Ticker._getTime();Ticker._interval=interval;Ticker._intervalID=setInterval(Ticker._tick,interval);}
Ticker.getInterval=function(){return Ticker._interval;}
Ticker.getFPS=function(){return 1000/Ticker._interval;}
Ticker.setFPS=function(value){Ticker.setInterval(1000/value);}
Ticker.getMeasuredFPS=function(ticks){if(Ticker._times.length<2){return-1;}
if(ticks==null){ticks=Ticker.getFPS()>>1;}
ticks=Math.min(Ticker._times.length-1,ticks);return 1000/((Ticker._times[0]-Ticker._times[ticks])/ticks);}
Ticker.setPaused=function(value){Ticker._paused=value;}
Ticker.getPaused=function(){return Ticker._paused;}
Ticker.getTime=function(pauseable){return Ticker._getTime()-Ticker._startTime-(pauseable?Ticker._pausedTime:0);}
Ticker.getTicks=function(pauseable){return Ticker._ticks-(pauseable?Ticker._pausedTickers:0);}
Ticker._tick=function(){Ticker._ticks++;var time=Ticker.getTime(false);var elapsedTime=time-Ticker._lastTime;var paused=Ticker._paused;if(paused){Ticker._pausedTickers++;Ticker._pausedTime+=elapsedTime;}
Ticker._lastTime=time;var pauseable=Ticker._pauseable;var listeners=Ticker._listeners;var l=listeners?listeners.length:0;for(var i=0;i<l;i++){var p=pauseable[i];var listener=listeners[i];if(listener==null||(paused&&p)||listener.tick==null){continue;}
listener.tick(elapsedTime);}
Ticker._times.unshift(time);if(Ticker._times.length>100){Ticker._times.pop();}}
Ticker._getTime=function(){return new Date().getTime();}
Ticker._startTime=Ticker._getTime();window.Ticker=Ticker;}(window));(function(window){UID=function(){throw"UID cannot be instantiated";}
UID._nextID=0;UID.get=function(){return UID._nextID++;}
window.UID=UID;}(window));(function(window){MouseEvent=function(type,stageX,stageY){this.initialize(type,stageX,stageY);}
var p=MouseEvent.prototype;p.stageX=0;p.stageY=0;p.type=null;p.onMouseMove=null;p.onMouseUp=null;p.initialize=function(type,stageX,stageY){this.type=type;this.stageX=stageX;this.stageY=stageY;}
p.clone=function(){return new MouseEvent(this.type,this.stageX,this.stageY);}
p.toString=function(){return"[MouseEvent (type="+this.type+" stageX="+this.stageX+" stageY="+this.stageY+")]";}
window.MouseEvent=MouseEvent;}(window));(function(window){Matrix2D=function(a,b,c,d,tx,ty){this.initialize(a,b,c,d,tx,ty);}
var p=Matrix2D.prototype;Matrix2D.identity=null;Matrix2D.DEG_TO_RAD=Math.PI/180;p.a=1;p.b=0;p.c=0;p.d=1;p.tx=0;p.ty=0;p.alpha=1;p.shadow=null;p.compositeOperation=null;p.initialize=function(a,b,c,d,tx,ty){if(a!=null){this.a=a;}
if(b!=null){this.b=b;}
if(c!=null){this.c=c;}
if(d!=null){this.d=d;}
if(tx!=null){this.tx=tx;}
if(ty!=null){this.ty=ty;}}
p.prepend=function(a,b,c,d,tx,ty){var tx1=this.tx;if(a!=1||b!=0||c!=0||d!=1){var a1=this.a;var c1=this.c;this.a=a1*a+this.b*c;this.b=a1*b+this.b*d;this.c=c1*a+this.d*c;this.d=c1*b+this.d*d;}
this.tx=tx1*a+this.ty*c+tx;this.ty=tx1*b+this.ty*d+ty;}
p.append=function(a,b,c,d,tx,ty){var a1=this.a;var b1=this.b;var c1=this.c;var d1=this.d;this.a=a*a1+b*c1;this.b=a*b1+b*d1;this.c=c*a1+d*c1;this.d=c*b1+d*d1;this.tx=tx*a1+ty*c1+this.tx;this.ty=tx*b1+ty*d1+this.ty;}
p.prependMatrix=function(matrix){this.prepend(matrix.a,matrix.b,matrix.c,matrix.d,matrix.tx,matrix.ty);this.prependProperties(matrix.alpha,matrix.shadow,matrix.compositeOperation);}
p.appendMatrix=function(matrix){this.append(matrix.a,matrix.b,matrix.c,matrix.d,matrix.tx,matrix.ty);this.appendProperties(matrix.alpha,matrix.shadow,matrix.compositeOperation);}
p.prependTransform=function(x,y,scaleX,scaleY,rotation,skewX,skewY,regX,regY){if(rotation%360){var r=rotation*Matrix2D.DEG_TO_RAD;var cos=Math.cos(r);var sin=Math.sin(r);}else{cos=1;sin=0;}
if(regX||regY){this.tx-=regX;this.ty-=regY;}
if(skewX||skewY){skewX*=Matrix2D.DEG_TO_RAD;skewY*=Matrix2D.DEG_TO_RAD;this.prepend(cos*scaleX,sin*scaleX,-sin*scaleY,cos*scaleY,0,0);this.prepend(Math.cos(skewY),Math.sin(skewY),-Math.sin(skewX),Math.cos(skewX),x,y);}else{this.prepend(cos*scaleX,sin*scaleX,-sin*scaleY,cos*scaleY,x,y);}}
p.appendTransform=function(x,y,scaleX,scaleY,rotation,skewX,skewY,regX,regY){if(rotation%360){var r=rotation*Matrix2D.DEG_TO_RAD;var cos=Math.cos(r);var sin=Math.sin(r);}else{cos=1;sin=0;}
if(skewX||skewY){skewX*=Matrix2D.DEG_TO_RAD;skewY*=Matrix2D.DEG_TO_RAD;this.append(Math.cos(skewY),Math.sin(skewY),-Math.sin(skewX),Math.cos(skewX),x,y);this.append(cos*scaleX,sin*scaleX,-sin*scaleY,cos*scaleY,0,0);}else{this.append(cos*scaleX,sin*scaleX,-sin*scaleY,cos*scaleY,x,y);}
if(regX||regY){this.tx-=regX*this.a+regY*this.c;this.ty-=regX*this.b+regY*this.d;}}
p.rotate=function(angle){var cos=Math.cos(angle);var sin=Math.sin(angle);var a1=this.a;var c1=this.c;var tx1=this.tx;this.a=a1*cos-this.b*sin;this.b=a1*sin+this.b*cos;this.c=c1*cos-this.d*sin;this.d=c1*sin+this.d*cos;this.tx=tx1*cos-this.ty*sin;this.ty=tx1*sin+this.ty*cos;}
p.skew=function(skewX,skewY){skewX=skewX*Matrix2D.DEG_TO_RAD;skewY=skewY*Matrix2D.DEG_TO_RAD;this.append(Math.cos(skewY),Math.sin(skewY),-Math.sin(skewX),Math.cos(skewX),0,0);}
p.scale=function(x,y){this.a*=x;this.d*=y;this.tx*=x;this.ty*=y;}
p.translate=function(x,y){this.tx+=x;this.ty+=y;}
p.identity=function(){this.alpha=this.a=this.d=1;this.b=this.c=this.tx=this.ty=0;this.shadow=this.compositeOperation=null;}
p.invert=function(){var a1=this.a;var b1=this.b;var c1=this.c;var d1=this.d;var tx1=this.tx;var n=a1*d1-b1*c1;this.a=d1/n;this.b=-b1/n;this.c=-c1/n;this.d=a1/n;this.tx=(c1*this.ty-d1*tx1)/n;this.ty=-(a1*this.ty-b1*tx1)/n;}
p.decompose=function(target){if(target==null){target={};}
target.x=this.tx;target.y=this.ty;target.scaleX=Math.sqrt(this.a*this.a+this.b*this.b);target.scaleY=Math.sqrt(this.c*this.c+this.d*this.d);var skewX=Math.atan2(-this.c,this.d);var skewY=Math.atan2(this.b,this.a);if(skewX==skewY){target.rotation=skewY/Matrix2D.DEG_TO_RAD;if(this.a<0&&this.d>=0){target.rotation+=(target.rotation<=0)?180:-180;}
target.skewX=target.skewY=0;}else{target.skewX=skewX/Matrix2D.DEG_TO_RAD;target.skewY=skewY/Matrix2D.DEG_TO_RAD;}
return target;}
p.appendProperties=function(alpha,shadow,compositeOperation){this.alpha*=alpha;this.shadow=shadow||this.shadow;this.compositeOperation=compositeOperation||this.compositeOperation;}
p.prependProperties=function(alpha,shadow,compositeOperation){this.alpha*=alpha;this.shadow=this.shadow||shadow;this.compositeOperation=this.compositeOperation||compositeOperation;}
p.clone=function(){var mtx=new Matrix2D(this.a,this.b,this.c,this.d,this.tx,this.ty);mtx.shadow=this.shadow;mtx.alpha=this.alpha;mtx.compositeOperation=this.compositeOperation;return mtx;}
p.toString=function(){return"[Matrix2D (a="+this.a+" b="+this.b+" c="+this.c+" d="+this.d+" tx="+this.tx+" ty="+this.ty+")]";}
Matrix2D.identity=new Matrix2D(1,0,0,1,0,0);window.Matrix2D=Matrix2D;}(window));(function(window){Point=function(x,y){this.initialize(x,y);}
var p=Point.prototype;p.x=0;p.y=0;p.initialize=function(x,y){this.x=(x==null?0:x);this.y=(y==null?0:y);}
p.clone=function(){return new Point(this.x,this.y);}
p.toString=function(){return"[Point (x="+this.x+" y="+this.y+")]";}
window.Point=Point;}(window));(function(window){Rectangle=function(x,y,width,height){this.initialize(x,y,width,height);}
var p=Rectangle.prototype;p.x=0;p.y=0;p.width=0;p.height=0;p.initialize=function(x,y,width,height){this.x=(x==null?0:x);this.y=(y==null?0:y);this.width=(width==null?0:width);this.height=(height==null?0:height);}
p.clone=function(){return new Rectangle(this.x,this.y,this.width,this.height);}
p.toString=function(){return"[Rectangle (x="+this.x+" y="+this.y+" width="+this.width+" height="+this.height+")]";}
window.Rectangle=Rectangle;}(window));(function(window){DisplayObject=function(){this.initialize();}
var p=DisplayObject.prototype;DisplayObject.suppressCrossDomainErrors=false;DisplayObject._hitTestCanvas=document.createElement("canvas");DisplayObject._hitTestCanvas.width=DisplayObject._hitTestCanvas.height=1;DisplayObject._hitTestContext=DisplayObject._hitTestCanvas.getContext("2d");DisplayObject._workingMatrix=new Matrix2D();p.alpha=1;p.cacheCanvas=null;p.id=-1;p.mouseEnabled=true;p.name=null;p.parent=null;p.regX=0;p.regY=0;p.rotation=0;p.scaleX=1;p.scaleY=1;p.skewX=0;p.skewY=0;p.shadow=null;p.visible=true;p.x=0;p.y=0;p.compositeOperation=null;p.snapToPixel=false;p.onPress=null;p.onClick=null;p.onMouseOver=null;p.onMouseOut=null;p._cacheOffsetX=0;p._cacheOffsetY=0;p._cacheDraw=false;p._activeContext=null;p._restoreContext=false;p._revertShadow=false;p._revertX=0;p._revertY=0;p._revertAlpha=1;p.initialize=function(){this.id=UID.get();this.children=[];}
p.isVisible=function(){return this.visible&&this.alpha>0&&this.scaleX!=0&&this.scaleY!=0;}
p.draw=function(ctx,ignoreCache){if(ignoreCache||!this.cacheCanvas){return false;}
ctx.translate(this._cacheOffsetX,this._cacheOffsetY);ctx.drawImage(this.cacheCanvas,0,0);ctx.translate(-this._cacheOffsetX,-this._cacheOffsetY);return true;}
p.cache=function(x,y,width,height){var ctx;if(this.cacheCanvas==null){this.cacheCanvas=document.createElement("canvas");}
ctx=this.cacheCanvas.getContext("2d");this.cacheCanvas.width=width;this.cacheCanvas.height=height;ctx.setTransform(1,0,0,1,-x,-y);ctx.clearRect(0,0,width+1,height+1);this.draw(ctx,true);this._cacheOffsetX=x;this._cacheOffsetY=y;}
p.updateCache=function(compositeOperation){if(this.cacheCanvas==null){throw"cache() must be called before updateCache()";}
var ctx=this.cacheCanvas.getContext("2d");ctx.setTransform(1,0,0,1,-this._cacheOffsetX,-this._cacheOffsetY);if(!compositeOperation){ctx.clearRect(0,0,this.cacheCanvas.width+1,this.cacheCanvas.height+1);}
else{ctx.globalCompositeOperation=compositeOperation;}
this.draw(ctx,true);if(compositeOperation){ctx.globalCompositeOperation="source-over";}}
p.uncache=function(){this.cacheCanvas=null;this.cacheOffsetX=this.cacheOffsetY=0;}
p.getStage=function(){var o=this;while(o.parent){o=o.parent;}
if(o instanceof Stage){return o;}
return null;}
p.localToGlobal=function(x,y){var mtx=this.getConcatenatedMatrix();if(mtx==null){return null;}
mtx.append(1,0,0,1,x,y);return new Point(mtx.tx,mtx.ty);}
p.globalToLocal=function(x,y){var mtx=this.getConcatenatedMatrix();if(mtx==null){return null;}
mtx.invert();mtx.append(1,0,0,1,x,y);return new Point(mtx.tx,mtx.ty);}
p.localToLocal=function(x,y,target){var pt=this.localToGlobal(x,y);return target.globalToLocal(pt.x,pt.y);}
p.getConcatenatedMatrix=function(mtx){if(mtx){mtx.identity();}
else{mtx=new Matrix2D();}
var target=this;while(target!=null){mtx.prependTransform(target.x,target.y,target.scaleX,target.scaleY,target.rotation,target.skewX,target.skewY,target.regX,target.regY);mtx.prependProperties(target.alpha,target.shadow,target.compositeOperation);target=target.parent;}
return mtx;}
p.hitTest=function(x,y){var ctx=DisplayObject._hitTestContext;var canvas=DisplayObject._hitTestCanvas;ctx.setTransform(1,0,0,1,-x,-y);this.draw(ctx);var hit=this._testHit(ctx);canvas.width=0;canvas.width=1;return hit;}
p.clone=function(){var o=new DisplayObject();this.cloneProps(o);return o;}
p.toString=function(){return"[DisplayObject (name="+this.name+")]";}
p.cloneProps=function(o){o.alpha=this.alpha;o.name=this.name;o.regX=this.regX;o.regY=this.regY;o.rotation=this.rotation;o.scaleX=this.scaleX;o.scaleY=this.scaleY;o.shadow=this.shadow;o.skewX=this.skewX;o.skewY=this.skewY;o.visible=this.visible;o.x=this.x;o.y=this.y;o.mouseEnabled=this.mouseEnabled;o.compositeOperation=this.compositeOperation;}
p.applyShadow=function(ctx,shadow){shadow=shadow||Shadow.identity;ctx.shadowColor=shadow.color;ctx.shadowOffsetX=shadow.offsetX;ctx.shadowOffsetY=shadow.offsetY;ctx.shadowBlur=shadow.blur;}
p._testHit=function(ctx){try{var hit=ctx.getImageData(0,0,1,1).data[3]>1;}catch(e){if(!DisplayObject.suppressCrossDomainErrors){throw"An error has occured. This is most likely due to security restrictions on reading canvas pixel "+"data with local or cross-domain images.";}}
return hit;}
window.DisplayObject=DisplayObject;}(window));(function(window){Bitmap=function(image){this.initialize(image);}
var p=Bitmap.prototype=new DisplayObject();p.image=null;p.snapToPixel=true;p.DisplayObject_initialize=p.initialize;p.initialize=function(image){this.DisplayObject_initialize();this.image=image;}
p.isVisible=function(){return this.visible&&this.alpha>0&&this.scaleX!=0&&this.scaleY!=0&&this.image&&(this.image.complete||this.image.getContext);}
p.DisplayObject_draw=p.draw;p.draw=function(ctx,ignoreCache){if(this.DisplayObject_draw(ctx,ignoreCache)){return true;}
ctx.drawImage(this.image,0,0);return true;}
p.clone=function(){var o=new Bitmap(this.image);this.cloneProps(o);return o;}
p.toString=function(){return"[Bitmap (name="+this.name+")]";}
window.Bitmap=Bitmap;}(window));(function(window){BitmapSequence=function(spriteSheet){this.initialize(spriteSheet);}
var p=BitmapSequence.prototype=new DisplayObject();p.callback=null;p.currentFrame=-1;p.waitFrame=0;p.currentWaitFrame=0;p.arrayFrames;p.arrayFramesPosition=0;p.nbSequenceToPlay=-1;p.nbSequencePlayed=0;p.currentSequence=null;p.currentEndFrame=null;p.currentStartFrame=null;p.nextSequence=null;p.paused=false;p.spriteSheet=null;p.snapToPixel=true;p.DisplayObject_initialize=p.initialize;p.initialize=function(spriteSheet){this.DisplayObject_initialize();this.spriteSheet=spriteSheet;}
p.isVisible=function(){var image=this.spriteSheet?this.spriteSheet.image:null;return this.visible&&this.alpha>0&&this.scaleX!=0&&this.scaleY!=0&&image&&this.currentFrame>=0&&(image.complete||image.getContext);}
p.DisplayObject_draw=p.draw;p.draw=function(ctx,ignoreCache){if(this.DisplayObject_draw(ctx,ignoreCache)){return true;}
var image=this.spriteSheet.image;var frameWidth=this.spriteSheet.frameWidth;var frameHeight=this.spriteSheet.frameHeight;var cols=image.width/frameWidth|0;var rows=image.height/frameHeight|0;if(this.currentEndFrame!=null){if(this.currentFrame>this.currentEndFrame){this.nbSequencePlayed++;if(this.nextSequence&&(this.nbSequenceToPlay==-1||this.nbSequenceToPlay>this.nbSequencePlayed)){this._goto(this.nextSequence);}else{this.paused=true;this.currentFrame=this.currentEndFrame;this.nbSequencePlayed=0;}
if(this.callback){this.callback(this);}}}else{var ttlFrames=this.spriteSheet.totalFrames||cols*rows;if(this.currentFrame>=ttlFrames){if(this.spriteSheet.loop){this.currentFrame=0;}
else{this.currentFrame=ttlFrames-1;this.paused=true;}
if(this.callback){this.callback(this);}}}
if(this.currentFrame>=0){var col=this.currentFrame%cols;var row=this.currentFrame/cols|0;ctx.drawImage(image,frameWidth*col,frameHeight*row,frameWidth,frameHeight,0,0,frameWidth,frameHeight);}
return true;}
p.tick=function(){if(this.currentFrame==-1&&this.spriteSheet.frameData){this.paused=true;}
if(this.paused){return;}
if(this.currentWaitFrame==this.waitFrame){if(this.arrayFrames){if(this.arrayFramesPosition>=this.arrayFrames.length){this.arrayFramesPosition=0;}
this.currentFrame=this.arrayFrames[this.arrayFramesPosition];this.arrayFramesPosition++;}
else{this.currentFrame++;}
this.currentWaitFrame=0;}
this.currentWaitFrame++;}
p.gotoAndPlay=function(frameOrSequence){this.paused=false;this._goto(frameOrSequence);}
p.gotoAndStop=function(frameOrSequence){this.paused=true;this._goto(frameOrSequence);}
p.clone=function(){var o=new BitmapSequence(this.spriteSheet);this.cloneProps(o);return o;}
p.toString=function(){return"[BitmapSequence (name="+this.name+")]";}
p.DisplayObject_cloneProps=p.cloneProps;p.cloneProps=function(o){this.DisplayObject_cloneProps(o);o.waitFrame=this.waitFrame;o.arrayFrames=this.arrayFrames;o.callback=this.callback;o.currentFrame=this.currentFrame;o.currentStartFrame=this.currentStartFrame;o.currentEndFrame=this.currentEndFrame;o.currentSequence=this.currentSequence;o.nextSequence=this.nextSequence;o.paused=this.paused;o.frameData=this.frameData;}
p._goto=function(frameOrSequence){if(isNaN(frameOrSequence)){if(frameOrSequence==this.currentSequence){this.currentFrame=this.currentStartFrame;return;}
var data=this.spriteSheet.frameData[frameOrSequence];if(data instanceof Array){this.currentFrame=this.currentStartFrame=data[0];this.currentSequence=frameOrSequence;this.currentEndFrame=data[1];if(this.currentEndFrame==null){this.currentEndFrame=this.currentStartFrame;}
if(this.currentEndFrame==null){this.currentEndFrame=this.currentFrame;}
this.nextSequence=data[2];if(this.nextSequence==null){this.nextSequence=this.currentSequence;}
else if(this.nextSequence==false){this.nextSequence=null;}}else{this.currentSequence=this.nextSequence=null;this.currentEndFrame=this.currentFrame=this.currentStartFrame=data;}}else{this.currentSequence=this.nextSequence=this.currentEndFrame=null;this.currentStartFrame=0;this.currentFrame=frameOrSequence;}}
window.BitmapSequence=BitmapSequence;}(window));(function(window){Container=function(){this.initialize();}
var p=Container.prototype=new DisplayObject();p.children=null;p.DisplayObject_initialize=p.initialize;p.initialize=function(){this.DisplayObject_initialize();this.children=[];}
p.isVisible=function(){return this.visible&&this.alpha>0&&this.children.length&&this.scaleX!=0&&this.scaleY!=0;}
p.DisplayObject_draw=p.draw;p.draw=function(ctx,ignoreCache,_mtx){var snap=Stage._snapToPixelEnabled;if(!_mtx){_mtx=new Matrix2D();_mtx.appendProperties(this.alpha,this.shadow,this.compositeOperation);}
if(this.DisplayObject_draw(ctx,ignoreCache)){return true;}
var l=this.children.length;var list=this.children.slice(0);for(var i=0;i<l;i++){var child=list[i];if(child.tick){child.tick();}
if(!child.isVisible()){continue;}
var shadow=false;var mtx=_mtx.clone();mtx.appendTransform(child.x,child.y,child.scaleX,child.scaleY,child.rotation,child.skewX,child.skewY,child.regX,child.regY);mtx.appendProperties(child.alpha,child.shadow,child.compositeOperation);if(!(child instanceof Container)){if(snap&&child.snapToPixel&&mtx.a==1&&mtx.b==0&&mtx.c==0&&mtx.d==1){ctx.setTransform(mtx.a,mtx.b,mtx.c,mtx.d,mtx.tx+0.5|0,mtx.ty+0.5|0);}else{ctx.setTransform(mtx.a,mtx.b,mtx.c,mtx.d,mtx.tx,mtx.ty);}
ctx.globalAlpha=mtx.alpha;ctx.globalCompositeOperation=mtx.compositeOperation||"source-over";if(shadow=mtx.shadow){this.applyShadow(ctx,shadow);}}
child.draw(ctx,false,mtx);if(shadow){this.applyShadow(ctx);}}
return true;}
p.addChild=function(child){var l=arguments.length;if(l>1){for(var i=0;i<l;i++){this.addChild(arguments[i]);}
return arguments[l-1];}
if(child.parent){child.parent.removeChild(child);}
child.parent=this;this.children.push(child);return child;}
p.addChildAt=function(child,index){var l=arguments.length;if(l>2){index=arguments[i-1];for(var i=0;i<l-1;i++){this.addChildAt(arguments[i],index+i);}
return arguments[l-2];}
if(child.parent){child.parent.removeChild(child);}
child.parent=this;this.children.splice(index,0,child);return child;}
p.removeChild=function(child){var l=arguments.length;if(l>1){var good=true;for(var i=0;i<l;i++){good=good&&this.removeChild(arguments[i]);}
return good;}
return this.removeChildAt(this.children.indexOf(child));}
p.removeChildAt=function(index){var l=arguments.length;if(l>1){var a=[];for(var i=0;i<l;i++){a[i]=arguments[i];}
a.sort(function(a,b){return b-a;})
var good=true;for(var i=0;i<l;i++){good=good&&this.removeChildAt(a[i]);}
return good;}
if(index<0||index>this.children.length-1){return false;}
var child=this.children[index];if(child!=null){child.parent=null;}
this.children.splice(index,1);return true;}
p.removeAllChildren=function(){while(this.children.length){this.removeChildAt(0);}}
p.getChildAt=function(index){return this.children[index];}
p.sortChildren=function(sortFunction){this.children.sort(sortFunction);}
p.getChildIndex=function(child){return this.children.indexOf(child);}
p.getNumChildren=function(){return this.children.length;}
p.contains=function(child){while(child){if(child==this){return true;}
child=child.parent;}
return false;}
p.hitTest=function(x,y){return(this.getObjectUnderPoint(x,y)!=null);}
p.getObjectsUnderPoint=function(x,y){var arr=[];var pt=this.localToGlobal(x,y);this._getObjectsUnderPoint(pt.x,pt.y,arr);return arr;}
p.getObjectUnderPoint=function(x,y){var pt=this.localToGlobal(x,y);return this._getObjectsUnderPoint(pt.x,pt.y);}
p.clone=function(recursive){var o=new Container();this.cloneProps(o);if(recursive){var arr=o.children=[];for(var i=0,l=this.children.length;i<l;i++){arr.push(this.children[i].clone(recursive));}}
return o;}
p.toString=function(){return"[Container (name="+this.name+")]";}
p._getObjectsUnderPoint=function(x,y,arr,mouseEvents){var ctx=DisplayObject._hitTestContext;var canvas=DisplayObject._hitTestCanvas;var mtx=DisplayObject._workingMatrix;var hasHandler=(mouseEvents&1&&(this.onPress||this.onClick))||(mouseEvents&2&&(this.onMouseOver||this.onMouseOut));if(this.cacheCanvas){this.getConcatenatedMatrix(mtx);ctx.setTransform(mtx.a,mtx.b,mtx.c,mtx.d,mtx.tx-x,mtx.ty-y);ctx.globalAlpha=mtx.alpha;this.draw(ctx);if(this._testHit(ctx)){canvas.width=0;canvas.width=1;if(hasHandler){return this;}}else{return null;}}
var l=this.children.length;for(var i=l-1;i>=0;i--){var child=this.children[i];if(!child.isVisible()||!child.mouseEnabled){continue;}
if(child instanceof Container){var result;if(hasHandler){result=child._getObjectsUnderPoint(x,y);if(result){return this;}}else{result=child._getObjectsUnderPoint(x,y,arr,mouseEvents);if(!arr&&result){return result;}}}else if(!mouseEvents||hasHandler||(mouseEvents&1&&(child.onPress||child.onClick))||(mouseEvents&2&&(child.onMouseOver||child.onMouseOut))){child.getConcatenatedMatrix(mtx);ctx.setTransform(mtx.a,mtx.b,mtx.c,mtx.d,mtx.tx-x,mtx.ty-y);ctx.globalAlpha=mtx.alpha;child.draw(ctx);if(!this._testHit(ctx)){continue;}
canvas.width=0;canvas.width=1;if(hasHandler){return this;}
else if(arr){arr.push(child);}
else{return child;}}}
return null;}
window.Container=Container;}(window));(function(window){function Command(f,params){this.f=f;this.params=params;}
Command.prototype.exec=function(scope){this.f.apply(scope,this.params);}
Graphics=function(instructions){this.initialize(instructions);}
var p=Graphics.prototype;Graphics.getRGB=function(r,g,b,alpha){if(r!=null&&b==null){alpha=g;b=r&0xFF;g=r>>8&0xFF;r=r>>16&0xFF;}
if(alpha==null){return"rgb("+r+","+g+","+b+")";}else{return"rgba("+r+","+g+","+b+","+alpha+")";}}
Graphics.getHSL=function(hue,saturation,lightness,alpha){if(alpha==null){return"hsl("+(hue%360)+","+saturation+"%,"+lightness+"%)";}else{return"hsla("+(hue%360)+","+saturation+"%,"+lightness+"%,"+alpha+")";}}
Graphics.STROKE_CAPS_MAP=["butt","round","square"];Graphics.STROKE_JOINTS_MAP=["miter","round","bevel"];Graphics._ctx=document.createElement("canvas").getContext("2d");Graphics.beginCmd=new Command(Graphics._ctx.beginPath,[]);Graphics.fillCmd=new Command(Graphics._ctx.fill,[]);Graphics.strokeCmd=new Command(Graphics._ctx.stroke,[]);p._strokeInstructions=null;p._strokeStyleInstructions=null;p._fillInstructions=null;p._instructions=null;p._oldInstructions=null;p._activeInstructions=null;p._active=false;p._dirty=false;p.initialize=function(instructions){this.clear();this._ctx=Graphics._ctx;with(this){eval(instructions);}}
p.draw=function(ctx){if(this._dirty){this._updateInstructions();}
var instr=this._instructions;for(var i=0,l=instr.length;i<l;i++){instr[i].exec(ctx);}}
p.moveTo=function(x,y){this._activeInstructions.push(new Command(this._ctx.moveTo,[x,y]));return this;}
p.lineTo=function(x,y){this._dirty=this._active=true;this._activeInstructions.push(new Command(this._ctx.lineTo,[x,y]));return this;}
p.arcTo=function(x1,y1,x2,y2,radius){this._dirty=this._active=true;this._activeInstructions.push(new Command(this._ctx.arcTo,[x1,y1,x2,y2,radius]));return this;}
p.arc=function(x,y,radius,startAngle,endAngle,anticlockwise){this._dirty=this._active=true;if(anticlockwise==null){anticlockwise=false;}
this._activeInstructions.push(new Command(this._ctx.arc,[x,y,radius,startAngle,endAngle,anticlockwise]));return this;}
p.quadraticCurveTo=function(cpx,cpy,x,y){this._dirty=this._active=true;this._activeInstructions.push(new Command(this._ctx.quadraticCurveTo,[cpx,cpy,x,y]));return this;}
p.bezierCurveTo=function(cp1x,cp1y,cp2x,cp2y,x,y){this._dirty=this._active=true;this._activeInstructions.push(new Command(this._ctx.bezierCurveTo,[cp1x,cp1y,cp2x,cp2y,x,y]));return this;}
p.rect=function(x,y,w,h){this._dirty=this._active=true;this._activeInstructions.push(new Command(this._ctx.rect,[x,y,w-1,h]));return this;}
p.closePath=function(){if(this._active){this._dirty=true;this._activeInstructions.push(new Command(this._ctx.closePath,[]));}
return this;}
p.clear=function(){this._instructions=[];this._oldInstructions=[];this._activeInstructions=[];this._strokeStyleInstructions=this._strokeInstructions=this._fillInstructions=null;this._active=this._dirty=false;return this;}
p.beginFill=function(color){if(this._active){this._newPath();}
this._fillInstructions=color?[new Command(this._setProp,["fillStyle",color])]:null;return this;}
p.beginLinearGradientFill=function(colors,ratios,x0,y0,x1,y1){if(this._active){this._newPath();}
var o=this._ctx.createLinearGradient(x0,y0,x1,y1);for(var i=0,l=colors.length;i<l;i++){o.addColorStop(ratios[i],colors[i]);}
this._fillInstructions=[new Command(this._setProp,["fillStyle",o])];return this;}
p.beginRadialGradientFill=function(colors,ratios,x0,y0,r0,x1,y1,r1){if(this._active){this._newPath();}
var o=this._ctx.createRadialGradient(x0,y0,r0,x1,y1,r1);for(var i=0,l=colors.length;i<l;i++){o.addColorStop(ratios[i],colors[i]);}
this._fillInstructions=[new Command(this._setProp,["fillStyle",o])];return this;}
p.beginBitmapFill=function(image,repetition){if(this._active){this._newPath();}
repetition=repetition||"";var o=this._ctx.createPattern(image,repetition);this._fillInstructions=[new Command(this._setProp,["fillStyle",o])];return this;}
p.endFill=function(){this.beginFill(null);return this;}
p.setStrokeStyle=function(thickness,caps,joints,miterLimit){if(this._active){this._newPath();}
this._strokeStyleInstructions=[new Command(this._setProp,["lineWidth",(thickness==null?"1":thickness)]),new Command(this._setProp,["lineCap",(caps==null?"butt":(isNaN(caps)?caps:Graphics.STROKE_CAPS_MAP[caps]))]),new Command(this._setProp,["lineJoin",(joints==null?"miter":(isNaN(joints)?joints:Graphics.STROKE_JOINTS_MAP[joints]))]),new Command(this._setProp,["miterLimit",(miterLimit==null?"10":miterLimit)])];return this;}
p.beginStroke=function(color){if(this._active){this._newPath();}
this._strokeInstructions=color?[new Command(this._setProp,["strokeStyle",color])]:null;return this;}
p.beginLinearGradientStroke=function(colors,ratios,x0,y0,x1,y1){if(this._active){this._newPath();}
var o=this._ctx.createLinearGradient(x0,y0,x1,y1);for(var i=0,l=colors.length;i<l;i++){o.addColorStop(ratios[i],colors[i]);}
this._strokeInstructions=[new Command(this._setProp,["strokeStyle",o])];return this;}
p.beginRadialGradientStroke=function(colors,ratios,x0,y0,r0,x1,y1,r1){if(this._active){this._newPath();}
var o=this._ctx.createRadialGradient(x0,y0,r0,x1,y1,r1);for(var i=0,l=colors.length;i<l;i++){o.addColorStop(ratios[i],colors[i]);}
this._strokeInstructions=[new Command(this._setProp,["strokeStyle",o])];return this;}
p.beginBitmapStroke=function(image,repetition){if(this._active){this._newPath();}
repetition=repetition||"";var o=this._ctx.createPattern(image,repetition);this._strokeInstructions=[new Command(this._setProp,["strokeStyle",o])];return this;}
p.endStroke=function(){this.beginStroke(null);return this;}
p.curveTo=p.quadraticCurveTo;p.drawRect=p.rect;p.drawRoundRect=function(x,y,w,h,radius){this.drawRoundRectComplex(x,y,w,h,radius,radius,radius,radius);return this;}
p.drawRoundRectComplex=function(x,y,w,h,radiusTL,radiusTR,radiusBR,radiusBL){this._dirty=this._active=true;this._activeInstructions.push(new Command(this._ctx.moveTo,[x+radiusTL,y]),new Command(this._ctx.lineTo,[x+w-radiusTR,y]),new Command(this._ctx.arc,[x+w-radiusTR,y+radiusTR,radiusTR,(-Math.PI/2),0,false]),new Command(this._ctx.lineTo,[x+w,y+h-radiusBR]),new Command(this._ctx.arc,[x+w-radiusBR,y+h-radiusBR,radiusBR,0,Math.PI/2,false]),new Command(this._ctx.lineTo,[x+radiusBL,y+h]),new Command(this._ctx.arc,[x+radiusBL,y+h-radiusBL,radiusBL,Math.PI/2,Math.PI,false]),new Command(this._ctx.lineTo,[x,y+radiusTL]),new Command(this._ctx.arc,[x+radiusTL,y+radiusTL,radiusTL,Math.PI,Math.PI*3/2,false]));return this;}
p.drawCircle=function(x,y,radius){this.arc(x,y,radius,0,Math.PI*2);return this;}
p.drawEllipse=function(x,y,w,h){this._dirty=this._active=true;var k=0.5522848;var ox=(w/2)*k;var oy=(h/2)*k;var xe=x+w;var ye=y+h;var xm=x+w/2;var ym=y+h/2;this._activeInstructions.push(new Command(this._ctx.moveTo,[x,ym]),new Command(this._ctx.bezierCurveTo,[x,ym-oy,xm-ox,y,xm,y]),new Command(this._ctx.bezierCurveTo,[xm+ox,y,xe,ym-oy,xe,ym]),new Command(this._ctx.bezierCurveTo,[xe,ym+oy,xm+ox,ye,xm,ye]),new Command(this._ctx.bezierCurveTo,[xm-ox,ye,x,ym+oy,x,ym]));return this;}
p.drawPolyStar=function(x,y,radius,sides,pointSize,angle){this._dirty=this._active=true;if(pointSize==null){pointSize=0;}
pointSize=1-pointSize;if(angle==null){angle=0;}
else{angle/=180/Math.PI;}
var a=Math.PI/sides;this._activeInstructions.push(new Command(this._ctx.moveTo,[x+Math.cos(angle)*radius,y+Math.sin(angle)*radius]));for(var i=0;i<sides;i++){angle+=a;if(pointSize!=1){this._activeInstructions.push(new Command(this._ctx.lineTo,[x+Math.cos(angle)*radius*pointSize,y+Math.sin(angle)*radius*pointSize]));}
angle+=a;this._activeInstructions.push(new Command(this._ctx.lineTo,[x+Math.cos(angle)*radius,y+Math.sin(angle)*radius]));}
return this;}
p.clone=function(){var o=new Graphics();o._instructions=this._instructions.slice();o._activeInstructions=this._activeInstructions.slice();o._oldInstructions=this._oldInstructions.slice();if(this._fillInstructions){o._fillInstructions=this._fillInstructions.slice();}
if(this._strokeInstructions){o._strokeInstructions=this._strokeInstructions.slice();}
if(this._strokeStyleInstructions){o._strokeStyleInstructions=this._strokeStyleInstructions.slice();}
o._active=this._active;o._dirty=this._dirty;return o;}
p.toString=function(){return"[Graphics]";}
p.mt=p.moveTo;p.lt=p.lineTo;p.at=p.arcTo;p.bt=p.bezierCurveTo;p.qt=p.quadraticCurveTo;p.a=p.arc;p.r=p.rect;p.cp=p.closePath;p.c=p.clear;p.f=p.beginFill;p.lf=p.beginLinearGradientFill;p.rf=p.beginRadialGradientFill;p.bf=p.beginBitmapFill;p.ef=p.endFill;p.ss=p.setStrokeStyle;p.s=p.beginStroke;p.ls=p.beginLinearGradientStroke;p.rs=p.beginRadialGradientStroke;p.bs=p.beginBitmapStroke;p.es=p.endStroke;p.dr=p.drawRect;p.rr=p.drawRoundRect;p.rc=p.drawRoundRectComplex;p.dc=p.drawCircle;p.de=p.drawEllipse;p.dp=p.drawPolyStar;p._updateInstructions=function(){this._instructions=this._oldInstructions.slice()
this._instructions.push(Graphics.beginCmd);if(this._fillInstructions){this._instructions.push.apply(this._instructions,this._fillInstructions);}
if(this._strokeInstructions){this._instructions.push.apply(this._instructions,this._strokeInstructions);if(this._strokeStyleInstructions){this._instructions.push.apply(this._instructions,this._strokeStyleInstructions);}}
this._instructions.push.apply(this._instructions,this._activeInstructions);if(this._fillInstructions){this._instructions.push(Graphics.fillCmd);}
if(this._strokeInstructions){this._instructions.push(Graphics.strokeCmd);}}
p._newPath=function(){if(this._dirty){this._updateInstructions();}
this._oldInstructions=this._instructions;this._activeInstructions=[];this._active=this._dirty=false;}
p._setProp=function(name,value){this[name]=value;}
window.Graphics=Graphics;}(window));(function(window){Shadow=function(color,offsetX,offsetY,blur){this.initialize(color,offsetX,offsetY,blur);}
var p=Shadow.prototype;Shadow.identity=null;p.color=null;p.offsetX=0;p.offsetY=0;p.blur=0;p.initialize=function(color,offsetX,offsetY,blur){this.color=color;this.offsetX=offsetX;this.offsetY=offsetY;this.blur=blur;}
p.toString=function(){return"[Shadow]";}
p.clone=function(){return new Shadow(this.color,this.offsetX,this.offsetY,this.blur);}
Shadow.identity=new Shadow(null,0,0,0);window.Shadow=Shadow;}(window));(function(window){Shape=function(graphics){this.initialize(graphics);}
var p=Shape.prototype=new DisplayObject();p.graphics=null;p.DisplayObject_initialize=p.initialize;p.initialize=function(graphics){this.DisplayObject_initialize();this.graphics=graphics?graphics:new Graphics();}
p.isVisible=function(){return this.visible&&this.alpha>0&&this.scaleX!=0&&this.scaleY!=0&&this.graphics;}
p.DisplayObject_draw=p.draw;p.draw=function(ctx,ignoreCache){if(this.DisplayObject_draw(ctx,ignoreCache)){return true;}
this.graphics.draw(ctx);return true;}
p.clone=function(recursive){var o=new Shape((recursive&&this.graphics)?this.graphics.clone():this.graphics);this.cloneProps(o);return o;}
p.toString=function(){return"[Shape (name="+this.name+")]";}
window.Shape=Shape;}(window));(function(window){SpriteSheet=function(image,frameWidth,frameHeight,frameData){this.initialize(image,frameWidth,frameHeight,frameData);}
var p=SpriteSheet.prototype;p.image=null;p.frameWidth=0;p.frameHeight=0;p.frameData=null;p.loop=true;p.totalFrames=0;p.initialize=function(image,frameWidth,frameHeight,frameData){this.image=image;this.frameWidth=frameWidth;this.frameHeight=frameHeight;this.frameData=frameData;}
p.toString=function(){return"[SpriteSheet]";}
p.clone=function(){var o=new SpriteSheet(this.image,this.frameWidth,this.frameHeight,this.frameData);o.loop=this.loop;o.totalFrames=this.totalFrames;return o;}
window.SpriteSheet=SpriteSheet;}(window));(function(window){Stage=function(canvas){this.initialize(canvas);}
var p=Stage.prototype=new Container();Stage._snapToPixelEnabled=false;p.autoClear=true;p.canvas=null;p.mouseX=null;p.mouseY=null;p.onMouseMove=null;p.onMouseUp=null;p.onMouseDown=null;p.snapToPixelEnabled=false;p.mouseInBounds=false;p._tmpCanvas=null;p._activeMouseEvent=null;p._activeMouseTarget=null;p._mouseOverIntervalID=null;p._mouseOverX=0;p._mouseOverY=0;p._mouseOverTarget=null;p.Container_initialize=p.initialize;p.initialize=function(canvas){this.Container_initialize();this.canvas=canvas;this.mouseChildren=true;var o=this;if(window.addEventListener){window.addEventListener("mouseup",function(e){o._handleMouseUp(e);},false);window.addEventListener("mousemove",function(e){o._handleMouseMove(e);},false);}else if(document.addEventListener){document.addEventListener("mouseup",function(e){o._handleMouseUp(e);},false);document.addEventListener("mousemove",function(e){o._handleMouseMove(e);},false);}
canvas.addEventListener("mousedown",function(e){o._handleMouseDown(e);},false);}
p.update=function(){if(!this.canvas){return;}
if(this.autoClear){this.clear();}
Stage._snapToPixelEnabled=this.snapToPixelEnabled;this.draw(this.canvas.getContext("2d"),false,this.getConcatenatedMatrix(DisplayObject._workingMatrix));}
p.tick=p.update;p.clear=function(){if(!this.canvas){return;}
var ctx=this.canvas.getContext("2d");ctx.setTransform(1,0,0,1,0,0);ctx.clearRect(0,0,this.canvas.width,this.canvas.height);}
p.toDataURL=function(backgroundColor,mimeType){if(!mimeType){mimeType="image/png";}
var ctx=this.canvas.getContext('2d');var w=this.canvas.width;var h=this.canvas.height;var data;if(backgroundColor){data=ctx.getImageData(0,0,w,h);var compositeOperation=ctx.globalCompositeOperation;ctx.globalCompositeOperation="destination-over";ctx.fillStyle=backgroundColor;ctx.fillRect(0,0,w,h);}
var dataURL=this.canvas.toDataURL(mimeType);if(backgroundColor){ctx.clearRect(0,0,w,h);ctx.putImageData(data,0,0);ctx.globalCompositeOperation=compositeOperation;}
return dataURL;}
p.enableMouseOver=function(frequency){if(this._mouseOverIntervalID){clearInterval(this._mouseOverIntervalID);this._mouseOverIntervalID=null;}
if(frequency<=0){return;}
var o=this;this._mouseOverIntervalID=setInterval(function(){o._testMouseOver();},1000/Math.min(50,frequency));this._mouseOverX=NaN;this._mouseOverTarget=null;}
p.clone=function(){var o=new Stage(null);this.cloneProps(o);return o;}
p.toString=function(){return"[Stage (name="+this.name+")]";}
p._handleMouseMove=function(e){if(!this.canvas){this.mouseX=this.mouseY=null;return;}
if(!e){e=window.event;}
var inBounds=this.mouseInBounds;this._updateMousePosition(e.pageX,e.pageY);if(!inBounds&&!this.mouseInBounds){return;}
var evt=new MouseEvent("onMouseMove",this.mouseX,this.mouseY);if(this.onMouseMove){this.onMouseMove(evt);}
if(this._activeMouseEvent&&this._activeMouseEvent.onMouseMove){this._activeMouseEvent.onMouseMove(evt);}}
p._updateMousePosition=function(pageX,pageY){var o=this.canvas;do{pageX-=o.offsetLeft;pageY-=o.offsetTop;}while(o=o.offsetParent);this.mouseInBounds=(pageX>=0&&pageY>=0&&pageX<this.canvas.width&&pageY<this.canvas.height);if(this.mouseInBounds){this.mouseX=pageX;this.mouseY=pageY;}}
p._handleMouseUp=function(e){var evt=new MouseEvent("onMouseUp",this.mouseX,this.mouseY);if(this.onMouseUp){this.onMouseUp(evt);}
if(this._activeMouseEvent&&this._activeMouseEvent.onMouseUp){this._activeMouseEvent.onMouseUp(evt);}
if(this._activeMouseTarget&&this._activeMouseTarget.onClick&&this._getObjectsUnderPoint(this.mouseX,this.mouseY,null,true,(this._mouseOverIntervalID?3:1))==this._activeMouseTarget){this._activeMouseTarget.onClick(new MouseEvent("onClick",this.mouseX,this.mouseY));}
this._activeMouseEvent=this.activeMouseTarget=null;}
p._handleMouseDown=function(e){if(this.onMouseDown){this.onMouseDown(new MouseEvent("onMouseDown",this.mouseX,this.mouseY));}
var target=this._getObjectsUnderPoint(this.mouseX,this.mouseY,null,(this._mouseOverIntervalID?3:1));if(target){if(target.onPress instanceof Function){var evt=new MouseEvent("onPress",this.mouseX,this.mouseY);target.onPress(evt);if(evt.onMouseMove||evt.onMouseUp){this._activeMouseEvent=evt;}}
this._activeMouseTarget=target;}}
p._testMouseOver=function(){if(this.mouseX==this._mouseOverX&&this.mouseY==this._mouseOverY&&this.mouseInBounds){return;}
var target=null;if(this.mouseInBounds){var target=this._getObjectsUnderPoint(this.mouseX,this.mouseY,null,3);this._mouseOverX=this.mouseX;this._mouseOverY=this.mouseY;}
if(this._mouseOverTarget!=target){if(this._mouseOverTarget&&this._mouseOverTarget.onMouseOut){this._mouseOverTarget.onMouseOut(new MouseEvent("onMouseOver",this.mouseX,this.mouseY));}
if(target&&target.onMouseOver){target.onMouseOver(new MouseEvent("onMouseOut",this.mouseX,this.mouseY));}
this._mouseOverTarget=target;}}
window.Stage=Stage;}(window));(function(window){Text=function(text,font,color){this.initialize(text,font,color);}
var p=Text.prototype=new DisplayObject();Text._workingContext=document.createElement("canvas").getContext("2d");p.text="";p.font=null;p.color=null;p.textAlign=null;p.textBaseline=null;p.maxWidth=null;p.outline=false;p.lineHeight=null;p.lineWidth=null;p.DisplayObject_initialize=p.initialize;p.initialize=function(text,font,color){this.DisplayObject_initialize();this.text=text;this.font=font;this.color=color?color:"#000";}
p.isVisible=function(){return Boolean(this.visible&&this.alpha>0&&this.scaleX!=0&&this.scaleY!=0&&this.text!=null&&this.text!="");}
p.DisplayObject_draw=p.draw;p.draw=function(ctx,ignoreCache){if(this.DisplayObject_draw(ctx,ignoreCache)){return true;}
if(this.outline){ctx.strokeStyle=this.color;}
else{ctx.fillStyle=this.color;}
ctx.font=this.font;ctx.textAlign=this.textAlign?this.textAlign:"start";ctx.textBaseline=this.textBaseline?this.textBaseline:"alphabetic";var lines=String(this.text).split(/(?:\r\n|\r|\n)/);var lineHeight=(this.lineHeight==null)?this.getMeasuredLineHeight():this.lineHeight;var y=0;for(var i=0,l=lines.length;i<l;i++){var w=ctx.measureText(lines[i]).width;if(this.lineWidth==null||w<this.lineWidth){this._drawTextLine(ctx,lines[i],y);y+=lineHeight;continue;}
var words=lines[i].split(/(\s)/);var str=words[0];for(var j=1,jl=words.length;j<jl;j+=2){if(ctx.measureText(str+words[j]+words[j+1]).width>this.lineWidth){this._drawTextLine(ctx,str,y);y+=lineHeight;str=words[j+1];}else{str+=words[j]+words[j+1];}}
this._drawTextLine(ctx,str,y);y+=lineHeight;}
return true;}
p.getMeasuredWidth=function(){return this._getWorkingContext().measureText(this.text).width;}
p.getMeasuredLineHeight=function(){return this._getWorkingContext().measureText("M").width*1.2;}
p.clone=function(){var o=new Text(this.text,this.font,this.color);this.cloneProps(o);return o;}
p.toString=function(){return"[Text (text="+(this.text.length>20?this.text.substr(0,17)+"...":this.text)+")]";}
p.DisplayObject_cloneProps=p.cloneProps;p.cloneProps=function(o){this.DisplayObject_cloneProps(o);o.textAlign=this.textAlign;o.textBaseline=this.textBaseline;o.maxWidth=this.maxWidth;o.outline=this.outline;o.lineHeight=this.lineHeight;o.lineWidth=this.lineWidth;}
p._getWorkingContext=function(){var ctx=Text._workingContext;ctx.font=this.font;ctx.textAlign=this.textAlign?this.textAlign:"start";ctx.textBaseline=this.textBaseline?this.textBaseline:"alphabetic";return ctx;}
p._drawTextLine=function(ctx,text,y){if(this.outline){ctx.strokeText(text,0,y,this.maxWidth);}
else{ctx.fillText(text,0,y,this.maxWidth);}}
window.Text=Text;}(window));